{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia</title>
    <link rel="stylesheet" href="{% static 'history_app/style.css' %}">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao&libraries=places&callback=initMap" async defer></script>
</head>
<body>
    <header>
        <h1>Historia</h1>
    </header>

    <main>
        <section id="location-search">
            <div id="search-container">
                <form id="search-form">
                    <input type="text" id="search-input" placeholder="Enter a location">
                    <button type="submit">Search</button>
                </form>
                <button id="get-location">Use My Location</button>
            </div>
            <p id="location"></p>
        </section>

        <section id="map-section">
            <div id="map"></div>
        </section>

        <section id="history-section">
            <div id="loading" style="display: none;">Loading...</div>
            <div id="history_data"></div>
        </section>
    </main>

    <footer>
        <p>&copy; {{ year }} Crafted with ❤️ by Josam Eneza Mmbuji</p>
    </footer>

    <script>
        let map;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 },
                zoom: 8
            });
        }

        document.getElementById('get-location').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                document.getElementById('location').innerHTML = "Geolocation is not supported by this browser.";
            }
        });

        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            document.getElementById('location').innerHTML = "Latitude: " + latitude + "<br>Longitude: " + longitude;
            sendLocationToServer(latitude, longitude, null);

            const mapLocation = { lat: latitude, lng: longitude };
            map.setCenter(mapLocation);
            new google.maps.Marker({ position: mapLocation, map: map });
        }

        document.getElementById('search-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const searchQuery = document.getElementById('search-input').value;
            geocodeAndShowHistory(searchQuery);
        });

        function geocodeAndShowHistory(searchQuery) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': searchQuery }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    const latitude = location.lat();
                    const longitude = location.lng();
                    const placeName = results[0].formatted_address;

                    document.getElementById('location').innerHTML = "Search Result: " + placeName;
                    sendLocationToServer(latitude, longitude, searchQuery);

                    const mapLocation = { lat: latitude, lng: longitude };
                    map.setCenter(mapLocation);
                    new google.maps.Marker({ position: mapLocation, map: map });
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function sendLocationToServer(latitude, longitude, searchQuery) {
            document.getElementById('loading').style.display = 'block';
            fetch('/get_history/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ latitude: latitude, longitude: longitude, search_query: searchQuery })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('history_data').innerHTML = data.history;
            })
            .catch((error) => {
                document.getElementById('loading').style.display = 'none';
                console.error('There has been a problem with your fetch operation:', error);
                document.getElementById('history_data').innerHTML = "Error retrieving history.";
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>